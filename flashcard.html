<!DOCTYPE html>
<html lang="vi">
<head>
    <link rel="preconnect" href="https://raw.githubusercontent.com">
    <link rel="dns-prefetch" href="https://raw.githubusercontent.com">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T·ª´ ƒêi·ªÉn H√°n Ng·ªØ Flashcard - Optimized</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        :root {
            --primary: #00a86b;
            --secondary: #1a5fb4;
            --bg: #f2f2f7;
            --text: #2c3e50;
        }

        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            overflow: hidden; /* Ch·∫∑n cu·ªôn to√†n trang ƒë·ªÉ tr√°nh l·ªói nh·∫£y lung tung */
            height: 100vh;
        }

        #book {
            height: 100vh;
            width: 100%;
            overflow-y: auto; /* Ch·ªâ cho ph√©p cu·ªôn b√™n trong n·ªôi dung th·∫ª n·∫øu th·∫ª qu√° d√†i */
            -webkit-overflow-scrolling: touch;
        }

        .flashcard {
            min-height: 100vh;
            width: 100%;
            padding: 20px;
            padding-bottom: 120px; 
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 15px;
            animation: fadeIn 0.3s ease; /* Hi·ªáu ·ª©ng chuy·ªÉn trang nh·∫π nh√†ng */
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header-section { background: white; border: 2px solid var(--primary); 
                         border-radius: 20px; padding: 20px; 
                         display: flex; 
                         justify-content: space-between; 
                         align-items: center; 
                         box-shadow: 0 4px 6px rgba(0,0,0,0.05); 
                         gap: 20px; /* T·∫°o kho·∫£ng c√°ch an to√†n ·ªü gi·ªØa */
                        }
        .big-char { font-size: 80px; font-weight: bold; margin: 0; line-height: 1; }
        .info-top { /* ƒê√¢y l√† "ph√©p thu·∫≠t" ƒë·ªÉ ƒë·∫©y c·∫£ kh·ªëi sang ph·∫£i m√† v·∫´n gi·ªØ cƒÉn tr√°i b√™n trong */
                margin-left: auto; 
                display: flex;
                flex-direction: column;
                align-items: flex-start; /* CƒÉn l·ªÅ tr√°i cho t·∫•t c·∫£ d√≤ng b√™n trong */
                text-align: left;        /* Ch·ªØ d√≥ng h√†ng b√™n tr√°i */}
        .pinyin-box { display: flex; align-items: center; justify-content: flex-end; gap: 8px; }
        .pinyin-tag { background: #34495e; color: white; padding: 2px 10px; border-radius: 10px; font-size: 11px; }
        .pinyin-text { font-size: 24px; color: var(--primary); font-weight: bold; }
        .han-viet { font-size: 20px; color: var(--secondary); font-weight: bold; margin: 5px 0; }
        .meaning-small { font-size: 13px; color: #666; margin: 2px 0; }
        .section-title { display: flex; align-items: center; gap: 8px; font-weight: bold; color: var(--secondary); margin-top: 5px; }
        .component-box { background: white; border-left: 6px solid #ff9f43; border-radius: 12px; padding: 15px; }
        .total-strokes { background: #e1f5fe; color: var(--primary); text-align: center; padding: 10px; border-radius: 10px; font-weight: bold; }
        .mnemonic-grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 12px; }
        .mnemonic-text { background: #fff9db; padding: 15px; border-radius: 15px; font-size: 13px; line-height: 1.5; }
        .mnemonic-img { width: 100%; height: 120px; object-fit: cover; border-radius: 15px; background: #eee; }
        .stroke-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; background: white; padding: 10px; border-radius: 15px; }
        .stroke-item { width: 100%; aspect-ratio: 1/1; object-fit: contain; }
        
        /* Nav Control t·ªëi ∆∞u cho Android */
        .nav-control {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 12px 25px;
            border-radius: 40px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            z-index: 9999;
        }

        .nav-btn { 
            background: none; border: none; font-size: 24px; cursor: pointer; color: #333; 
            touch-action: manipulation; padding: 5px 15px;
        }
        
        .dots { display: flex; gap: 8px; }
        .dot { width: 8px; height: 8px; background: #ddd; border-radius: 50%; }
        .dot.active { background: var(--primary); width: 20px; border-radius: 10px; }

        .ext-vocab-item { background: #f9fafb; border: 1px solid #eee; border-radius: 12px; padding: 12px; margin-bottom: 10px; }
        .ext-vocab-item:hover {
                background-color: #f0f7ff; /* M√†u xanh d∆∞∆°ng c·ª±c nh·∫°t */
                border-left: 3px solid #1E90FF; /* Thanh nh·∫•n m√†u xanh d∆∞∆°ng b√™n tr√°i */
                border-radius: 8px;
        }
        .ext-han { display: flex; align-items: center; gap: 8px; font-size: 20px; font-weight: bold; }
        .ext-pinyin { font-size: 14px; color: var(--primary); }
        .speak-btn { background: none; border: 1px solid #eee; border-radius: 50%; cursor: pointer; }
        #loading { position: fixed; inset: 0; background: white; display: flex; justify-content: center; align-items: center; z-index: 10000; }
    </style>
</head>
<body>

<div id="loading">ƒêang t·∫£i d·ªØ li·ªáu...</div>
<div id="book">
    </div>

<div class="nav-control">
    <button class="nav-btn" onpointerdown="prevPage()">‚Üê</button>
    <div id="pageDots" class="dots"></div>
    <button class="nav-btn" onpointerdown="nextPage()">‚Üí</button>
</div>

<script>
    const sheetUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vRZTDVNcUri3PK3TkRuafajK9Vj8pyPKF79H6JYCzu1l56OM-xbgO7bWdcR84o_FJ8FUXuNe0ALyd7r/pub?output=csv';

    let allData = []; // Bi·∫øn ch√≠nh l∆∞u tr·ªØ d·ªØ li·ªáu
    let currentIndex = 0;
    let totalItems = 0;

    function init() {
        const urlParams = new URLSearchParams(window.location.search);
        const selectedStatus = urlParams.get('status') || 'Ready';
        Papa.parse(sheetUrl, {
            download: true,
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                // L·ªçc d·ªØ li·ªáu
                allData = results.data.filter(item => item['Status']?.trim() === selectedStatus);

                if (selectedStatus === 'Ready' && allData.length > 0) {
                    // ƒê·∫¢O NG·∫™U NHI√äN
                    shuffleArray(allData);
                }
                
                // GI·∫¢I PH√ìNG B·ªò NH·ªö: X√≥a k·∫øt qu·∫£ g·ªëc c·ªßa PapaParse
                results = null; 

                const loading = document.getElementById('loading');
                loading.style.display = 'none';

                if (allData.length === 0) {
                    document.getElementById('book').innerHTML = '<div class="empty-state">Kh√¥ng c√≥ d·ªØ li·ªáu s·∫µn s√†ng.</div>';
                    return;
                }
                
                totalItems = allData.length;
                renderCard(currentIndex);
                createDots();
            }
        });
    }

    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [array[i], array[j]] = [array[j], array[i]];
      }
    }
  
    // H√†m render ƒê√öNG 1 CARD duy nh·∫•t
    function renderCard(index) {
        const book = document.getElementById('book');
        const item = allData[index];
        
        // Reset v·ªã tr√≠ cu·ªôn l√™n ƒë·∫ßu card m·ªõi
        book.scrollTop = 0;

        const strokeLinks = item['GIF Th·ª© t·ª± n√©t'] ? item['GIF Th·ª© t·ª± n√©t'].split(', ') : [];
        const strokesHtml = strokeLinks.length > 0 
            ? strokeLinks.map(link => `<img class="stroke-item" src="${link.trim()}" loading="lazy">`).join('')
            : '<p style="grid-column: span 2; font-size:12px; color:#999; text-align:center;">ƒêang c·∫≠p nh·∫≠t...</p>';

        const vocabList = parseExtendedVocab(item['·ª®ng d·ª•ng - T·ª´ v·ª±ng m·ªü r·ªông']);
        const vocabHtml = vocabList.length
            ? vocabList.map(v => `
                <div class="ext-vocab-item" onclick="speak_all(\`${v.han}\`, \`${v.vi}\`, \`${v.en}\`)"
                     style="cursor: pointer; transition: background 0.2s;">
                    <div class="ext-han">${v.han} <button class="speak-btn" onclick="event.stopPropagation(); speak('${v.han}')">üîä</button></div>
                    <div class="ext-pinyin">${v.pinyin}</div>
                    <div class="ext-vi">${v.vi}</div>
                    <div class="ext-vi">${v.en} <button class="speak-btn" onclick="event.stopPropagation(); speak_en('${v.en}')">üîä</button></div>
                </div>
            `).join('')
            : '<div style="font-size:12px;color:#999">Ch∆∞a c√≥ d·ªØ li·ªáu.</div>';

        // Ghi ƒë√® to√†n b·ªô n·ªôi dung c≈© (X√≥a card c≈© kh·ªèi DOM)
        book.innerHTML = `
            <div class="flashcard">
                <div class="header-section">
                    <h1 class="big-char">${item['T·ª´ ti·∫øng Trung'] || 'Ôºü'}</h1>
                    <div class="info-top">
                        <div class="pinyin-box">
                            <span class="pinyin-tag">Pinyin</span>
                            <span class="pinyin-text">${item['Pinyin'] || ''}</span>
                            <button class="speak-btn" onclick="speak('${item['T·ª´ ti·∫øng Trung']}')">üîä</button>
                        </div>
                        <div class="han-viet">H√°n Vi·ªát: ${item['Nghƒ©a H√°n Vi·ªát'] || ''}</div>
                        <p class="meaning-small">‚óè Vi·ªát: ${item['Nghƒ©a ti·∫øng Vi·ªát'] || ''}</p>
                        <p class="meaning-small">‚óè English: ${item['Nghƒ©a ti·∫øng Anh'] || ''}
                            <button class="speak-btn" onclick="speak_en('${item['Nghƒ©a ti·∫øng Anh'] || ''}')">üîä</button>
                        </p>
                    </div>
                </div>

                <div class="section-title">üë£ Th√†nh ph·∫ßn c·∫•u t·∫°o</div>
                <div class="component-box">
                    <strong>${nl2br(item['Th√†nh ph·∫ßn c·∫•u t·∫°o (B·ªô th·ªß)'])}</strong>
                    <div style="font-size:13px; color:#666; margin-top:5px;">
                        ${nl2br(item['Ph√¢n t√≠ch k·ªπ h∆°n c·∫•u t·∫°o'])|| ''}
                    </div>
                </div>
 
                <div class="total-strokes">T·ªîNG C·ªòNG: ${item['T·ªïng s·ªë n√©t'] || '0'} N√âT</div>

                <div class="mnemonic-grid">
                    <div class="mnemonic-text">
                        <strong style="color:#f39c12">üí° M·∫πo ghi nh·ªõ</strong><br>
                        ${nl2br(item['M·∫πo nh·ªõ']) || ''}
                    </div>
                    <img class="mnemonic-img" src="${item['·∫¢nh minh h·ªça ƒë√£ ch·ªçn'] || ''}" onerror="this.src='https://i.postimg.cc/d3VVgr6y/image.png'">
                </div>

                <div class="section-title">‚úçÔ∏è Th·ª© t·ª± n√©t vi·∫øt
                    <button class="nav-btn" onclick="resetStrokes()">üîÑ Replay</button>
                </div>
                
                <div class="stroke-grid">${strokesHtml}</div>
                
                <div class="section-title">üìö T·ª´ v·ª±ng m·ªü r·ªông</div>
                <div style="background:white; padding:15px; border-radius:15px;">${vocabHtml}</div>
            </div>
        `;
        
        updateDots();
    }

    function resetStrokes() {
        const imgs = document.querySelectorAll('.stroke-item');
        if (!imgs.length) return;

        imgs.forEach(img => {
            const baseSrc = img.src.split('?')[0];
            img.src = baseSrc + '?t=' + Date.now();
        });
    }
    
    function nextPage() {
        if (currentIndex < totalItems - 1) {
            currentIndex++;
            renderCard(currentIndex);
        }
    }

    function prevPage() {
        if (currentIndex > 0) {
            currentIndex--;
            renderCard(currentIndex);
        }
    }

    function createDots() {
        const dotsContainer = document.getElementById('pageDots');
        dotsContainer.innerHTML = '';
        const limit = Math.min(totalItems, 5); 
        for (let i = 0; i < limit; i++) {
            const dot = document.createElement('div');
            dot.className = 'dot';
            dot.onpointerdown = () => { currentIndex = i; renderCard(i); };
            dotsContainer.appendChild(dot);
        }
        updateDots();
    }

    function updateDots() {
        const dots = document.querySelectorAll('.dot');
        const activeIdx = currentIndex % 5; // Gi·∫£ l·∫≠p v√≤ng l·∫∑p 5 dots
        dots.forEach((dot, i) => {
            dot.classList.toggle('active', i === activeIdx);
        });
    }

    function nl2br(text) { return text ? text.replace(/\\n/g, '<br>') : ''; }

    function parseExtendedVocab(text) {
        if (!text) return [];
        return text.split(/\\n|\r?\n/).map(line => {
            const parts = line.replace(/^\d+\.\s*/, '').split(' - ').map(p => p.trim());
            return { han: parts[0] || '', pinyin: parts[1] || '', vi: parts[2] || '', 'en': parts[3] || ''};
        }).filter(v => v.han);
    }

    function speak(text) {
        const utter = new SpeechSynthesisUtterance(text);
        utter.lang = 'zh-CN';
        window.speechSynthesis.speak(utter);
    }

    function speak_en(text) {
        if (!text) return;
    
        // D·ª´ng c√°c y√™u c·∫ßu n√≥i c≈©
        window.speechSynthesis.cancel();

        // L√†m s·∫°ch chu·ªói: Thay / th√†nh d·∫•u ph·∫©y ƒë·ªÉ ngh·ªâ nh·ªãp, 
        // v√† ƒë·∫£m b·∫£o c√°c k√Ω t·ª± ƒë·∫∑c bi·ªát kh√¥ng g√¢y l·ªói
        const cleanText = text.replace(/\//g, ',');

        const utter = new SpeechSynthesisUtterance(cleanText);
        utter.lang = 'en-US';
    
        // T√πy ch·ªânh m√†u xanh d∆∞∆°ng cho t√¢m tr·∫°ng vui v·∫ª
        utter.rate = 0.9; // ƒê·ªçc ch·∫≠m l·∫°i m·ªôt ch√∫t cho r√µ
    
        window.speechSynthesis.speak(utter);
    }

    function speak_all(cn, vi, en) {
        window.speechSynthesis.cancel();

        // H√†m ph·ª• ƒë·ªÉ t·∫°o l∆∞·ª£t ƒë·ªçc
        const createUtterance = (text, lang) => {
            const utter = new SpeechSynthesisUtterance(text.replace(/\//g, ','));
            utter.lang = lang;
            return utter;
        };

        // H√†m th·ª±c hi·ªán vi·ªác ƒë·ªçc l·∫∑p l·∫°i
        const speakLoop = (text, lang, times, callback) => {
            let count = 0;

            const run = () => {
                if (count < times) {
                    const utter = createUtterance(text, lang);
                    utter.onend = () => {
                        count++;
                        if (count < times) {
                            // Ngh·ªâ 300ms gi·ªØa c√°c l·∫ßn l·∫∑p c√πng ng√¥n ng·ªØ
                            setTimeout(run, 300);
                        } else if (callback) {
                            // Ngh·ªâ 1000ms (1 gi√¢y) khi chuy·ªÉn sang ng√¥n ng·ªØ kh√°c
                            setTimeout(callback, 1000);
                        }
                    };
                    window.speechSynthesis.speak(utter);
                }
            };
            run();
        };

        // B·∫Øt ƒë·∫ßu chu·ªói tr√¨nh t·ª±:
        // 1. Ti·∫øng Trung (3 l·∫ßn) -> sau ƒë√≥:
        // 2. Ti·∫øng Vi·ªát (1 l·∫ßn) -> sau ƒë√≥:
        // 3. Ti·∫øng Anh (2 l·∫ßn)
        speakLoop(cn, 'zh-CN', 3, () => {
            speakLoop(vi, 'vi-VN', 1, () => {
                speakLoop(en, 'en-US', 2);
            });
        });
    }
    
    init();
</script>
</body>
</html>





